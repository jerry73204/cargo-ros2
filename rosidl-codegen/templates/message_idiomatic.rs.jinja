// Idiomatic Rust layer - user-friendly types
// Package: {{ package_name }}
// Message: {{ message_name }}

use serde::{Deserialize, Serialize};

{% for constant in constants %}
pub const {{ constant.name }}: {{ constant.rust_type }} = {{ constant.value }};
{% endfor %}

#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub struct {{ message_name }} {
    {% for field in fields %}
    pub {{ field.name }}: {{ field.rust_type }},
    {% endfor %}
}

impl {{ message_name }} {
    pub fn new() -> Self {
        Self::default()
    }
}

impl Default for {{ message_name }} {
    fn default() -> Self {
        // Leverage FFI message's C init function to get correct default values
        <Self as crate::rosidl_runtime_rs::Message>::from_rmw_message(crate::ffi::msg::{{ message_name|snake_case }}::{{ message_name }}::default())
    }
}

// Conversion between FFI and idiomatic layers
impl From<crate::ffi::msg::{{ message_name|snake_case }}::{{ message_name }}> for {{ message_name }} {
    fn from(rmw: crate::ffi::msg::{{ message_name|snake_case }}::{{ message_name }}) -> Self {
        Self {
            {% for field in fields %}
            {{ field.name }}: rmw.{{ field.name }}.into(),
            {% endfor %}
        }
    }
}

impl From<{{ message_name }}> for crate::ffi::msg::{{ message_name|snake_case }}::{{ message_name }} {
    fn from(idiomatic: {{ message_name }}) -> Self {
        Self {
            {% for field in fields %}
            {{ field.name }}: idiomatic.{{ field.name }}.into(),
            {% endfor %}
        }
    }
}

// Message trait implementation for rosidl_runtime_rs
impl crate::rosidl_runtime_rs::Message for {{ message_name }} {
    type RmwMsg = crate::ffi::msg::{{ message_name|snake_case }}::{{ message_name }};

    fn into_rmw_message(msg_cow: std::borrow::Cow<'_, Self>) -> std::borrow::Cow<'_, Self::RmwMsg> {
        // Convert from idiomatic to RMW format
        std::borrow::Cow::Owned(msg_cow.into_owned().into())
    }

    fn from_rmw_message(msg: Self::RmwMsg) -> Self {
        // Convert from RMW to idiomatic format
        msg.into()
    }
}
