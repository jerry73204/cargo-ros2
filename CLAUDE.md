# cargo-ros2: All-in-One ROS 2 Rust Build Tool

## Project Overview

**cargo-ros2** is a next-generation, unified build tool for ROS 2 Rust projects that solves the fundamental circular dependency problem in current ros2_rust implementations **and** provides complete ament-compatible installation.

**Core Innovation**:
1. **Pre-build**: Project-local binding generation in `target/ros2_bindings/` with automatic Cargo patch management
2. **Post-build**: Complete ament layout installation (absorbing cargo-ament-build functionality)

**📖 See `docs/UNIFIED_ARCHITECTURE.md` for the complete architectural design.**

## The Problem We're Solving

### Current ros2_rust Issues

1. **Circular Dependency**:
   - Cargo.toml requires `vision_msgs = "*"`
   - Cargo queries crates.io → finds yanked version
   - .cargo/config.toml patch points to `install/vision_msgs/.../rust/`
   - But that path doesn't exist until after build starts
   - **Result**: Build fails unless interface packages are pre-built in workspace

2. **System Package Incompatibility**:
   - `ros-humble-vision-msgs` (apt) only has C/C++/Python bindings
   - No Rust bindings in `/opt/ros/humble/`
   - User must manually build interface packages locally
   - Requires colcon workspace with specific build order

3. **Workspace Requirement**:
   - Can't build standalone Rust ROS projects
   - Must use colcon with 3-stage build (ros2_rust → interface → packages)
   - Complex setup for simple projects

### Our Solution

**Unified all-in-one build tool** approach:
1. **Pre-build**: `cargo ros2` intercepts build process
2. Discovers ROS packages via `ament_index` (works with system packages!)
3. Generates Rust bindings to `target/ros2_bindings/<pkg>/`
4. Auto-configures `.cargo/config.toml` patches
5. **Build**: Invokes standard `cargo build` (or `check` for pure libs)
6. **Post-build**: Installs to ament layout (replaces cargo-ament-build)
   - Binaries → `install/<pkg>/lib/<pkg>/`
   - Source → `install/<pkg>/share/<pkg>/rust/`
   - Markers → `share/ament_index/resource_index/`
7. Success - ready for colcon!

## Architecture

### Directory Structure

```
my_robot_project/
├── Cargo.toml                    # Standard manifest
├── .cargo/
│   └── config.toml               # Auto-generated patches
├── target/
│   ├── ros2_bindings/            # Virtual registry (generated by cargo-ros2)
│   │   ├── vision_msgs/
│   │   │   ├── Cargo.toml
│   │   │   ├── src/lib.rs        # FFI bindings
│   │   │   └── build.rs          # Links C libs
│   │   └── sensor_msgs/
│   ├── debug/
│   └── release/
├── .ros2_bindgen_cache           # Metadata (checksums, timestamps)
└── src/
    └── main.rs
```

### User Workflow

```bash
# 1. Create project (standard Cargo)
cargo new my_robot && cd my_robot

# 2. Add ROS dependencies (standard Cargo.toml)
[dependencies]
rclrs = "0.4"
vision_msgs = "*"
sensor_msgs = "*"

# 3. Build with wrapper (all magic happens here)
cargo ros2 build

# Behind the scenes:
# - Discovers vision_msgs via ament_index (apt-installed package!)
# - Generates to target/ros2_bindings/vision_msgs/
# - Patches .cargo/config.toml
# - Runs cargo build
# - Success!
```

## Key Design Principles

1. **Project-Isolated**: Bindings in `target/` → no global state, `cargo clean` works
2. **Zero Configuration**: User writes normal Cargo.toml, wrapper handles everything
3. **System Package Compatible**: Discovers ROS packages via `ament_index`
4. **Standard Cargo Experience**: Patches are transparent, normal deps in Cargo.toml
5. **Incremental**: Smart caching avoids regeneration (checksum-based)
6. **colcon-Friendly**: Drop-in replacement for current cargo invocations

## Implementation Status

**Current Phase**: Design & Documentation (Phase 0)

See `docs/ROADMAP.md` for detailed implementation plan.

## Quick Reference

### Commands (Future)

```bash
cargo ros2 build                        # Build with binding generation
cargo ros2 clean                        # Clean bindings + artifacts
cargo ros2 check                        # Fast check (reuses bindings)
cargo ros2 test                         # Test with bindings
cargo ros2 cache --list                 # Show cached bindings
cargo ros2 cache --rebuild              # Force regeneration
cargo ros2 ament-build --install-base <path>  # Generate + build + install (with cargo-ament-build)
```

### Key Files

- `CLAUDE.md` - This file (project instructions)
- `docs/UNIFIED_ARCHITECTURE.md` - **⭐ NEW: Complete unified architecture (absorbing cargo-ament-build)**
- `docs/DESIGN.md` - Detailed technical design
- `docs/ROADMAP.md` - Implementation roadmap with phases
- `docs/CARGO_AMENT_INTEGRATION.md` - Integration with cargo-ament-build (historical context)
- `docs/COLCON_PLUGINS_COMPARISON.md` - Difference between colcon-cargo and colcon-ros-cargo
- `docs/COMPARISON.md` - Comparison with ros2_rust, r2r, etc. (future)

## Development Guidelines

### Temporary Files

**Important**: All temporary files and directories (downloads, clones, analysis artifacts) should be created in `$PROJECT_ROOT/tmp/`. This directory is gitignored and keeps the workspace clean.

```bash
# Use project-local tmp directory
mkdir -p tmp/
cd tmp/
# ... work with temporary files ...
```

### Code Quality

```bash
cargo fmt                     # Format code
cargo clippy -- -D warnings   # Lint with warnings as errors
cargo test                    # Run tests
```

### Documentation

- Keep DESIGN.md up-to-date with architecture changes
- Update ROADMAP.md when completing phases
- Add examples for each feature
- Document edge cases and limitations

### Testing Strategy

1. **Unit tests**: Core binding generation logic
2. **Integration tests**: Full workflow with mock ROS packages
3. **Real-world tests**: Test with actual ROS 2 installations (Humble, Iron, Jazzy)
4. **Regression tests**: Known issues from ros2_rust (yanked deps, etc.)

## Related Projects

- **ros2_rust**: Current official Rust bindings (workspace-based approach)
- **r2r**: Alternative bindings (build.rs generation, slower builds)
- **cargo-ament-build**: Installs Cargo artifacts in ament layout (**being absorbed into cargo-ros2**)
- **colcon-ros-cargo**: Build plugin we'll integrate with (and potentially fork/modify)

## License

MIT OR Apache-2.0 (to be decided - compatible with ROS 2 ecosystem)

## Contributing

(To be added once project is public)

---

**Status**: Design phase (2025-01-29)
**Next**: Implement Phase 1 MVP (see docs/ROADMAP.md)
