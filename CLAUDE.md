# cargo-ros2: All-in-One ROS 2 Rust Build Tool

## Project Overview

**cargo-ros2** is a next-generation, unified build tool for ROS 2 Rust projects that solves the fundamental circular dependency problem in current ros2_rust implementations **and** provides complete ament-compatible installation.

**Core Innovation**:
1. **Pre-build**: Project-local binding generation in `target/ros2_bindings/` with automatic Cargo patch management
2. **Post-build**: Complete ament layout installation (absorbing cargo-ament-build functionality)

**ðŸ“– See `docs/UNIFIED_ARCHITECTURE.md` for the complete architectural design.**

## The Problem We're Solving

### Current ros2_rust Issues

1. **Circular Dependency**:
   - Cargo.toml requires `vision_msgs = "*"`
   - Cargo queries crates.io â†’ finds yanked version
   - .cargo/config.toml patch points to `install/vision_msgs/.../rust/`
   - But that path doesn't exist until after build starts
   - **Result**: Build fails unless interface packages are pre-built in workspace

2. **System Package Incompatibility**:
   - `ros-humble-vision-msgs` (apt) only has C/C++/Python bindings
   - No Rust bindings in `/opt/ros/humble/`
   - User must manually build interface packages locally
   - Requires colcon workspace with specific build order

3. **Workspace Requirement**:
   - Can't build standalone Rust ROS projects
   - Must use colcon with 3-stage build (ros2_rust â†’ interface â†’ packages)
   - Complex setup for simple projects

### Our Solution

**Unified all-in-one build tool** approach:
1. **Pre-build**: `cargo ros2` intercepts build process
2. Discovers ROS packages via `ament_index` (works with system packages!)
3. Generates Rust bindings to `target/ros2_bindings/<pkg>/`
4. Auto-configures `.cargo/config.toml` patches
5. **Build**: Invokes standard `cargo build` (or `check` for pure libs)
6. **Post-build**: Installs to ament layout (replaces cargo-ament-build)
   - Binaries â†’ `install/<pkg>/lib/<pkg>/`
   - Source â†’ `install/<pkg>/share/<pkg>/rust/`
   - Markers â†’ `share/ament_index/resource_index/`
7. Success - ready for colcon!

## Architecture

### Two-Tool Design

**cargo-ros2** is split into two complementary tools:

1. **`cargo-ros2-bindgen`** - Low-level binding generator
   - Generates Rust bindings for a single ROS interface package
   - Can be used standalone
   - MVP: Shells out to Python `rosidl_generator_rs`

2. **`cargo-ros2`** - High-level build orchestrator
   - Three-phase workflow: generate bindings â†’ build â†’ install
   - Discovers ROS dependencies from Cargo.toml
   - Manages cache, patches .cargo/config.toml
   - Absorbs cargo-ament-build functionality

### Directory Structure

```
my_robot_project/
â”œâ”€â”€ Cargo.toml                    # Standard manifest
â”œâ”€â”€ .cargo/
â”‚   â””â”€â”€ config.toml               # Auto-generated patches
â”œâ”€â”€ target/
â”‚   â”œâ”€â”€ ros2_bindings/            # Virtual registry (generated by cargo-ros2)
â”‚   â”‚   â”œâ”€â”€ vision_msgs/
â”‚   â”‚   â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”‚   â”‚   â”œâ”€â”€ src/lib.rs        # FFI bindings
â”‚   â”‚   â”‚   â””â”€â”€ build.rs          # Links C libs
â”‚   â”‚   â””â”€â”€ sensor_msgs/
â”‚   â”œâ”€â”€ debug/
â”‚   â””â”€â”€ release/
â”œâ”€â”€ .ros2_bindgen_cache           # Metadata (checksums, timestamps)
â””â”€â”€ src/
    â””â”€â”€ main.rs
```

### User Workflow

```bash
# 1. Create project (standard Cargo)
cargo new my_robot && cd my_robot

# 2. Add ROS dependencies (standard Cargo.toml)
[dependencies]
rclrs = "0.4"
vision_msgs = "*"
sensor_msgs = "*"

# 3. Build with wrapper (all magic happens here)
cargo ros2 build

# Behind the scenes:
# - Discovers vision_msgs via ament_index (apt-installed package!)
# - Generates to target/ros2_bindings/vision_msgs/
# - Patches .cargo/config.toml
# - Runs cargo build
# - Success!
```

## Key Design Principles

1. **Project-Isolated**: Bindings in `target/` â†’ no global state, `cargo clean` works
2. **Zero Configuration**: User writes normal Cargo.toml, wrapper handles everything
3. **System Package Compatible**: Discovers ROS packages via `ament_index`
4. **Standard Cargo Experience**: Patches are transparent, normal deps in Cargo.toml
5. **Incremental**: Smart caching avoids regeneration (checksum-based)
6. **colcon-Friendly**: Drop-in replacement for current cargo invocations

## Implementation Status

**Current Phase**: Phase 2 Complete! âœ…

**Completed**:
- âœ… **Phase 0**: Project Preparation (3/3 subphases)
- âœ… **Phase 1**: Native Rust IDL Generator (6/6 subphases)
  - Full rosidl parser (messages, services, actions)
  - Askama-based code generator
  - FFI bindings and runtime traits
  - 80 tests passing
- âœ… **Phase 2**: cargo-ros2 Tools (2/2 subphases)
  - **cargo-ros2-bindgen**: Standalone binding generator (13 tests)
  - **cargo-ros2**: Complete build workflow with caching (26 tests)
  - 151 total tests passing

**What Works Now**:
- Generate Rust bindings for any ROS 2 interface package
- Discover packages from system installation
- Intelligent SHA256-based caching
- Automatic .cargo/config.toml patching
- Complete CLI: `build`, `check`, `clean`

**Next**: Phase 3 (Production Features) - See `docs/ROADMAP.md` for details.

## Quick Reference

### Commands

**cargo-ros2-bindgen** (standalone tool):
```bash
# Generate bindings for a single package
cargo-ros2-bindgen --package std_msgs --output target/ros2_bindings

# With verbose output
cargo-ros2-bindgen --package geometry_msgs --output ./bindings --verbose

# Using direct path (bypasses ament index)
cargo-ros2-bindgen --package my_msgs --output ./out --package-path /path/to/share
```

**cargo-ros2** (main build tool):
```bash
cargo ros2 build                        # âœ… Build with binding generation
cargo ros2 build --verbose              # âœ… Verbose output
cargo ros2 build --bindings-only        # âœ… Generate bindings only (no build)

cargo ros2 check                        # âœ… Fast check (reuses bindings)
cargo ros2 check --bindings-only        # âœ… Generate bindings only (no check)

cargo ros2 clean                        # âœ… Clean bindings + cache
```

**Future enhancements**:
```bash
cargo ros2 test                         # Test with bindings
cargo ros2 cache --list                 # Show cached bindings
cargo ros2 cache --rebuild              # Force regeneration
cargo ros2 ament-build --install-base <path>  # Generate + build + install (Phase 3+)
```

### Key Files

**Primary Documentation** (minimalist style):
- `CLAUDE.md` - This file (project instructions)
- `docs/ARCH.md` - **â­ Architecture overview (two-tool design)**
- `docs/DESIGN.md` - Implementation details
- `docs/ROADMAP.md` - Phase-by-phase implementation plan

**Reference**:
- `external/` - ros2_rust packages for reference (rosidl_rust, rosidl_runtime_rs, etc.)
- `tmp/` - Cloned repos for analysis (cargo-ament-build, colcon-ros-cargo)
- `docs/archive/` - Verbose design docs (historical)

## Development Guidelines

### Temporary Files

**Important**: All temporary files and directories (downloads, clones, analysis artifacts) should be created in `$PROJECT_ROOT/tmp/`. This directory is gitignored and keeps the workspace clean.

```bash
# Use project-local tmp directory
mkdir -p tmp/
cd tmp/
# ... work with temporary files ...
```

### File Manipulation Tools

**Prefer Claude Code tools over Bash commands** for file operations:

- âœ… **Use**: `Write` tool to create new files in `tmp/`
- âœ… **Use**: `Edit` tool to modify files in `tmp/`
- âœ… **Use**: `Read` tool to view file contents
- âŒ **Avoid**: `cat`, `echo >`, `cat <<EOF`, or heredocs via Bash

**Rationale**: Claude Code's file tools provide better error handling, proper escaping, and cleaner interaction. Bash commands like `cat` and `echo` are prone to quoting issues and don't integrate well with the tool ecosystem.

**Example**:
```
# âŒ Don't do this:
Bash: cat > tmp/test.rs <<'EOF'
fn main() { println!("test"); }
EOF

# âœ… Do this instead:
Write: tmp/test.rs
Content: fn main() { println!("test"); }
```

### Code Quality

```bash
cargo fmt                     # Format code
cargo clippy -- -D warnings   # Lint with warnings as errors
cargo test                    # Run tests
```

### Documentation

- Keep DESIGN.md up-to-date with architecture changes
- Update ROADMAP.md when completing phases
- Add examples for each feature
- Document edge cases and limitations

### Testing Strategy

1. **Unit tests**: Core binding generation logic
2. **Integration tests**: Full workflow with mock ROS packages
3. **Real-world tests**: Test with actual ROS 2 installations (Humble, Iron, Jazzy)
4. **Regression tests**: Known issues from ros2_rust (yanked deps, etc.)

## Related Projects

- **ros2_rust**: Current official Rust bindings (workspace-based approach)
- **r2r**: Alternative bindings (build.rs generation, slower builds)
- **cargo-ament-build**: Installs Cargo artifacts in ament layout (**being absorbed into cargo-ros2**)
- **colcon-ros-cargo**: Build plugin we'll integrate with (and potentially fork/modify)

## License

MIT OR Apache-2.0 (to be decided - compatible with ROS 2 ecosystem)

## Contributing

(To be added once project is public)

---

**Status**: Phase 2 Complete - Production-ready tools (2025-11-02)
**Progress**: 11/20 subphases (55%) | 151 tests passing
**Next**: Phase 3 - Production Features (see docs/ROADMAP.md)
